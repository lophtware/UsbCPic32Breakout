#!/bin/bash

mkdir -p ~/.pickle;
cd $(mktemp -d);

cat <<EOF > ~/.pickle/RIPE_20a_000510.hex
:020000040000fa
:10030000bc4100a09c33f07fbd4100a0bd53fc0266
:10031000a84100a00831fd068845000cf54fe5cb4b
:100320000074ce04000ce54b9f450d4ca74100a086
:10033000e730000fc7300001470ca54120ffd0690e
:10034000a0e9226dc2b4fbff000cf54fa24100a052
:100350004230000f42400400e5cb06cca7002ce061
:10036000a54100e0a530000f0074f404000ce54b3b
:100370009f450d4ce14f3d2318d005944900a50e33
:10038000240eb74100a0f732000f77002ce09790c1
:100390000000a24100e04230000f8300181044c862
:1003a000c0334000d70eb04120ff959241005e0c53
:1003b0009502181082403300820e242696005021a8
:1003c000570c8069a0e9226d82b4fbff000c22cc9f
:1003d000000c00f4f404bdfc100026ad3132000125
:1003e00011cc9502d0a9600e910c0074de04b20c01
:1003f0001bad644e946c9302501376ad52320800dc
:100400009502d0a915b4d3ff959241000dcc400cb4
:100410000bcc400cd4b7e7ff560edbcf910cc2b724
:10042000efff910cd6cf000c3d2318509f45214c77
:10043000e5401000f14f6445040e450e200e007497
:100440000405900c058d906c51b6f9ff1032000830
:100450002445114cbf45000cf54fe5cb0074100549
:10046000000ce54b9f450d4cd526a68ea641c01f1e
:10047000400cc630fc2fa941ff7f2951ffffa74147
:10048000c0bfe730fc2f0031ffffc4940400000c14
:10049000e4b40800000cc06923950900206d2e6d9e
:1004a0009f4501edc06903b50900000c206da2b4a1
:1004b000ecff426e9f45400c9f45400c9f4501ed6f
:1004c000b04f426940c8e5400b00d426400ca6411d
:1004d00020ffa805b069e3e9226da2b4fbffa805df
:1004e0009f45054cf14f6445040e450e260e00f461
:1004f000ba058050ffffa241004050009013048dc8
:10050000a44100a004cce044a44100c04006007413
:100510008405b20c00746c05000c10e9400c2445f5
:100520009f45114ca241004044009013e240080056
:10053000a24100a0e244d80787ae400c9f4560e985
:10054000a24100c0f8cf2806406ecf09e4b4fcfffa
:10055000340560e9400cbf45e14f3d2318d0840ebf
:1005600005949100c50ebe4100a0de33000f7e0051
:100570002ce09e900000a24100e04230000f83007a
:10058000181044c8a24100a04230000e62002ce0c6
:1005900082900000a24100e04230000e830018105b
:1005a00045c8600e01eee00eb14100a031320010ee
:1005b000b04120ffb24100a042cc5232000f80690e
:1005c000a0e9226d22b6fbff000c08ae543000fffc
:1005d00000745405000ce20e543000ffe20218983b
:1005e00013b409005630c0ff940c00f41805bdfc8c
:1005f00010005630c0ff629040009dadb432000143
:10060000a24100a04230000e8069a0e9226d42b6ee
:10061000fbff000c00745405000c5400189813b430
:100620000600e20e950c00f41805bdfc14005630cf
:1006300080ffb4320002058d800c950ec20ebfcf34
:100640005e0c00745405000c06ad82edb34023002f
:1006500017cca24120ffa24120ffa3e913940a0076
:10066000b53200ffa24120ff62fa0c001fcc400c03
:10067000b53200ffa24120ffa2fa0c0017cc400cbb
:1006800023e814cc400c00745405000c0aad82ed34
:10069000f7cfa24120ffa24120ffa3e9e5cfa2416d
:1006a00020ffa24120ffa3e9e3cfb40e3d23185061
:1006b0009f45214cf94fe3cb4900fc0040c869003d
:1006c000fc00404827058200901379ade34b9f451d
:1006d000094c000cf14f4645040ea24120ffa069d1
:1006e00064c8206945c800f45a038030f401900cb6
:1006f0000074de04896e06459f45114ce94fbd220a
:1007000018d0a24180bf62fe603673022c3ba2412a
:100710000a005300909ab24100a052323c07a24115
:1007200020ffa06a0502408050b00f00029497009d
:1007300085d2ffff12021811a245000c9f0700a0ee
:10074000d10700a0df0700a0790700a0b10700a033
:10075000bd0700a0110800a06d0800a0290800a096
:10076000f50700a08b0800a05f0800a0430800a0c8
:100770005f0800a08d0700a0a24120ffa068a06a2a
:100780000074ce04910c8ecc70000080a24120ff3a
:10079000a06800746a03910c85cc70000080a241af
:1007a00020ffa06800749601910c7ccc7000008042
:1007b00000741005000c76cc70000080a24120ff70
:1007c000a068910c00741802b40c6ccc700000800e
:1007d000a24120ffa06802ed63cc20021810a241c4
:1007e00020ffa068a06a910c0074ac02d52699cfb6
:1007f000a24120ffa24120ffa06882fe00009402d7
:100800004010910c0074ba01b40c4ccc7000008004
:10081000a24120ffa06882fe0000910c0074340207
:10082000b40c40cc70000080a24120ffa06882fe82
:100830000000910cb40c00747202096f33cc70008c
:10084000008005c8a24120ffa06882fe0000910c34
:10085000b40c007492020b6f25cc7000008007ed81
:1008600050b40f0003ed06cca34107004030100543
:10087000a3410700d344a34120ff33e952cfa24153
:1008800020ff0aed50b40800000ca24120ff62fadc
:100890000c0047cfa24120ff02ed509440ff03ed32
:1008a000700000801c8da44120ff20cc635002000a
:1008b00000746002b40c35cfa24120ff6448a3e964
:1008c00030cfa24120ff70b42aff000c02b427fff2
:1008d000a24120ff6548a3e924cfa24120ffc3e93c
:1008e00081ed70b40d0088ede3cf910ca44120ffa1
:1008f000c3e988ed70b4e7ff8ced13cfa24120ff70
:1009000070b4e1ff8ceddacfa24120ffa24180bf9d
:1009100082f830298450004082f83029a24180bffb
:1009200002f84029a84180bf08513029a94199aa5d
:1009300029515566aa4166554a51aa99ab41000012
:100940006b510080ac4100008c51808028f9100070
:1009500048f9100088f97000000c28f9100048f9d7
:10096000100068f90800a34180bf43fc30292e2df8
:10097000a240fbff000c000c000c000c603000409b
:10098000a24180bf62f83429a24180bf42fc3029d5
:100990009f4542d00020000c9f45400cf54fe5cb11
:1009a000a24180bf82f85029a24180bfa2f86029ed
:1009b0000074860401eee54b9f450d4cf54fe5cbe9
:1009c000a24180bf82f85029d069a24180bf62f85d
:1009d0006029d169a24180bf62f870290074860441
:1009e00002eee54b9f450d4cf54fe5cba24180bf94
:1009f00082f85029a24180bfa2f8802900748604a1
:100a000003eee54b9f450d4cf54fe5cba24180bf72
:100a100082f850290074860404eee54b9f450d4c86
:100a2000f54fe5cb007486040eeee54b9f450d4c6b
:100a3000a24180bf82f85029a24180bfa2f880293c
:100a4000a24180bf83ed62f830296030034062f834
:100a50003029a24180bf02f84029a84180bf085137
:100a60003029a94199aa29515566aa4166554a518a
:100a7000aa99ab4100006b510080ac4100008c5141
:100a8000808028f9100048f9100088f97000000ce7
:100a900028f9100048f9100068f90800000c000c53
:100aa000000c000c9f45400ca34180bf43fc302943
:100ab0002e2da240fbff000c000c000c000c60303f
:100ac0000040a24180bf62f83429a24180bf42fcad
:100ad00030299f4542d00020a24100a09f454234ca
:100ae0000400000c4d2ea24100a062340400b12687
:100af0006544a54100a0a530000f85001821b02550
:100b00005c449f4562380400e5400e00f14f5545b6
:100b1000040e250e006c00f472059014ffff9e6c0d
:100b2000faac006c1545114cbf45000ca74100a064
:100b3000e730000fc00c0031000160264f2e88ed19
:100b4000400c4400102ba5003c3b45400600000c27
:100b500022254270211003cc2f2d22252f2d422635
:100b6000be6defad4f2e70e9606f06b5e6fff26f18
:100b7000bf45000cf54f4445b04100a010f80000ff
:100b8000a24100a000f496058238040001ed50f85f
:080b9000000004459f450d4cd7
:020000040000fa
:040b9800abcd1005cc
:020000040000fa
:100b9c00000e00a000020000000000000000000099
:00000001FF
EOF

wget "http://wiki.kewl.org/downloads/pickle-4.20.tgz";
tar xzvf pickle-4.20.tgz;
cd pickle-4.20;

cat <<EOF | patch src/pic32.c
287a288
> {"PIC32MM0256GPM028",	PIC32MM0256GPM028, DS60001387D,	PIC32_WORD(6),PIC32_WORD(256), 64,512},
348c349
< #if 0
---
> 
349a351
> #if 0
351a354,357
> 
> 	/* PIC32MM0064/0128/0256GPM0XX      */
> 	{DS60001387D,	"RIPE_20a_000510"},
> 
799c805,806
< 	case DS60001324B: /* PIC32MM */
---
> 	case DS60001324B: /* PIC32MM GPL */
> 	case DS60001387D: /* PIC32MM GPM */
881c888,889
< 		(pic32_map[pic32_index].datasheet == DS60001324B)) {	/* MM */
---
> 		(pic32_map[pic32_index].datasheet == DS60001324B) ||
> 		(pic32_map[pic32_index].datasheet == DS60001387D)) {	/* MM */
947c955,956
< 		(pic32_map[pic32_index].datasheet != DS60001324B)) {	/* ! MM */
---
> 		(pic32_map[pic32_index].datasheet != DS60001324B) &&
> 		(pic32_map[pic32_index].datasheet != DS60001387D)) {	/* ! MM */
1185c1194
<  * Download the PE for PIC32MM devices
---
>  * Download the PE for PIC32MM GPL devices
1190c1199
< pic32_download_custom_pe_mm(uint8_t *pe, uint32_t nbytes)
---
> pic32_download_custom_pe_mm_gpl(uint8_t *pe, uint32_t nbytes)
1241d1249
< #if 0
1243c1251,1253
<  * Download the PE for PIC32MM devices
---
>  * Download the PE for PIC32MM GPM devices
>  *
>  * DS60001364D-pages 22 and 23
1245,1246c1255
<  * DS60001145P-page 25
<  * DS60001364C-page 23
---
>  * XXX DATA-SHEET INVALID XXX
1248c1257,1259
<  * XXX DATA-SHEET INVALID
---
>  * BUT THIS POST IS SPOT-ON:
>  *
>  *     https://www.microchip.com/forums/m973762.aspx
1251c1262
< pic32_download_pe_mm(uint8_t *pe, uint32_t nbytes)
---
> pic32_download_custom_pe_mm_gpm(uint8_t *pe, uint32_t nbytes)
1255,1277c1266,1276
< 		0xDEAD41A7, // lui a3, 0xdead
< 		0xFF2041A6, // lui a2, 0xff20
< 		0xFF2041A5, // lui al, 0xff20
< 			    // here1:
< 		0x69E06A60, // lw a0, 0 (a2)
< 			    // lw v1, 0 (a2)
< 		0x000C94E3, // beq v1, a3, <here3>
< 		0x8DFA0C00, // nop16
< 			    // beqz v1, <here1>
< 			    // here2:
< 			    // lw v0, 0 (a1)
< 		0xE9406DBE, // addiu v1, v1, -1
< 			    // sw v0, 0 (a0)
< 		0xADFB6E42, // addiu a0, a0, 4
< 			    // bnez v1, <here2>
< 		0xCFF20C00, // nop16
< 			    // b <here1>
< 		0x0C000C00, // nop16; nop16
< 			    // here3:
< 		0xA00041A2, // lui v0, 0xa000
< 		0x03005042, // ori v0, v0, 0x300
< 		0x0C004582, // jr v0
< 			    // nop16
---
> 		0xFF2041A3,
> 		0xDEAD41A5,
> 		0x69306A30,
> 		0x000994A2,
> 		0xA00041B9,
> 		0xFFF840E2,
> 		0xEB406B30,
> 		0xCFFA6E42,
> 		0x33396D2E,
> 		0x45990301,
> 		0x0C000C00
1279d1277
< 	#define PESIZE (sizeof(peloader) / sizeof(uint32_t))
1281c1279
< printf("%s() 1\n", __func__);
---
> 	#define PESIZE (sizeof(peloader) / sizeof(uint32_t))
1287c1285
< 	 * ori a0,a0,0x200 XXX
---
> 	 * ori a0,a0,0x200
1312c1310
< 	 * ori t9,t9,0x200 XXX
---
> 	 * ori t9,t9,0x201
1313a1312,1313
> 	 * nop16; nop16
> 	 * nop16; nop16
1317c1317
< 	pic32_xferinstruction(0x02005339);
---
> 	pic32_xferinstruction(0x02015339);
1318a1319,1320
> 	pic32_xferinstruction(0x0C000C00);
> 	pic32_xferinstruction(0x0C000C00);
1324,1325d1325
< printf("%s() 2\n", __func__);
< 
1341,1342d1340
< printf("%s() 3\n", __func__);
< 
1347d1344
< #endif
1450c1447,1448
< 	case DS60001324B: /* PIC32MM */
---
> 	case DS60001324B: /* PIC32MM GPL */
> 	case DS60001387D: /* PIC32MM GPM */
1683c1681,1682
< 	case DS60001324B: /* PIC32MM */
---
> 	case DS60001324B: /* PIC32MM GPL */
> 	case DS60001387D: /* PIC32MM GPM */
1811,1812c1810,1814
< 	case DS60001324B: /* PIC32MM */
< 		pic32_download_custom_pe_mm(pe, nbytes);
---
> 	case DS60001324B: /* PIC32MM GPL */
> 		pic32_download_custom_pe_mm_gpl(pe, nbytes);
> 		break;
> 	case DS60001387D: /* PIC32MM GPM */
> 		pic32_download_custom_pe_mm_gpm(pe, nbytes);
1917,1918c1919,1923
< 	case DS60001324B: /* PIC32MM */
< 		pic32_conf.devidaddr = PIC32MM_DEVID;
---
> 	case DS60001324B: /* PIC32MM GPL */
> 		pic32_conf.devidaddr = PIC32MM_GPL_DEVID;
> 		break;
> 	case DS60001387D: /* PIC32MM GPM */
> 		pic32_conf.devidaddr = PIC32MM_GPM_DEVID;
1948c1953,1954
< 	case DS60001324B: /* PIC32MM */
---
> 	case DS60001324B: /* PIC32MM GPL */
> 	case DS60001387D: /* PIC32MM GPM */
2314c2320,2321
< 	case DS60001324B: /* PIC32MM */
---
> 	case DS60001324B: /* PIC32MM GPL */
> 	case DS60001387D: /* PIC32MM GPM */
EOF

cat <<EOF | patch src/pic32.h
82,85c82,86
< #define PIC32_PERI     (0xBF800000)	/* 0xBF800000 .. 0xBF8FFFFF PERIPHERAL    */
< #define PIC32_DEVID    (0xBF80F220)	/* DEVICE ID PIC32   */
< #define PIC32MM_DEVID  (0xBF803B20)	/* DEVICE ID PIC32MM */
< #define PIC32_IDMASK   (0x0FFFFFFF)
---
> #define PIC32_PERI        (0xBF800000)	/* 0xBF800000 .. 0xBF8FFFFF PERIPHERAL    */
> #define PIC32_DEVID       (0xBF80F220)	/* DEVICE ID PIC32   */
> #define PIC32MM_GPL_DEVID (0xBF803B20)	/* DEVICE ID PIC32MMxxxxGPLyyy */
> #define PIC32MM_GPM_DEVID (0xBF803660)	/* DEVICE ID PIC32MMxxxxGPMyyy */
> #define PIC32_IDMASK      (0x0FFFFFFF)
367a369,378
> 
> /*
>  * PIC32MM0016/0032/0064/0128/0256GPM0XX
>  *
>  * Programming spec.
>  *
>  * DS60001387D
>  */
> #define DS60001387D (60001387)
> #define PIC32MM0256GPM028 (0x07718053)
EOF

make && sudo make install;

cat <<EOF > ~/.pickle/config
DEVICE=RPI3
SLEEP=1
BITRULES=0x0F00
BUSY=0

VPP=25
PGM=-1
PGC=17
PGD=16

DEBUG=10
EOF
